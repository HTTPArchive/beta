{% extends "main.html" %}


{% block title %}{{ super() }} | {{ report.name }}{% endblock %}

{% block main %}
	<h1>{{ report.name }}</h1>

	<h2>Table of Contents</h2>
	<ul id="TOC">
	{% for metric, options in report.metrics.items() %}
		<li>
			<a href="#{{ metric }}">{{ options.name }}</a>
			<ul>
				<li>
					<a href="#{{ metric }}-chart">Chart</a>
				</li>
				<li>
					<a href="#{{ metric }}-table">Table</a>
				</li>
			</ul>
		</li>
	{% endfor %}
	</ul>

	{% for metric, options in report.metrics.items() %}
		<section id="{{ metric }}">
			<h2>{{ options.name }}</h2>
			<div id="{{ metric }}-chart" class="chart"></div>
			<table id="{{ metric }}-table" class="table"></table>
		</section>
	{% endfor %}

	<script src="https://code.highcharts.com/stock/highstock.js"></script>
	<script src="https://code.highcharts.com/stock/highcharts-more.js"></script>
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<script src="/static/js/timeseries.js"></script>
	<script>
function timeseries(metric, options) {
	const dataUrl = `https://storage.googleapis.com/httparchive/reports/${metric}.json`;
	options.chartId = `${metric}-chart`;
	options.tableId = `${metric}-table`;
	options.metric = metric;

	fetch(dataUrl)
		.then(response => response.text())
		.then(jsonStr => JSON.parse(jsonStr))
		.then(data => data.sort((a, b) => a.date < b.date ? -1 : 1))
		.then(data => {
			drawTimeseries(data, options);
			drawTimeseriesTable(data, options);
		});
}
{% for metric, options in report.metrics.items() %}
	timeseries('{{ metric }}', {{ options|tojson }});
{% endfor %}
	</script>
{% endblock %}
